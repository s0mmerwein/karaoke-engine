<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Karaoke Admin</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="style.css" />
  </head>
  <body>
    <div class="admin-root">
      <header class="admin-header">
        <div>
          <h1>Karaoke Flow – Selector</h1>
          <div class="admin-subtitle">
            Open this page in the laptop browser. Then open
            <span class="text-emotional">projector.html</span> in a second
            window for the projector.
          </div>
        </div>
        <div class="kbd-hint">
          Buzzer:
          <span class="kbd">1</span> Power,
          <span class="kbd">2</span> Emotional,
          <span class="kbd">3</span> Evergreen
        </div>
      </header>

      <main class="admin-columns">
        <section class="admin-column" id="slot-power">
          <div class="admin-column-header">
            <div class="admin-column-title">Slot 1</div>
            <div class="admin-column-badge power">Power</div>
          </div>
          <div class="admin-ticket-shell">
            <div class="admin-ticket-empty">
              No suggestion yet. Use
              <span class="text-power">Generate Suggestions</span>.
            </div>
          </div>
        </section>

        <section class="admin-column" id="slot-emotional">
          <div class="admin-column-header">
            <div class="admin-column-title">Slot 2</div>
            <div class="admin-column-badge emotional">Emotional</div>
          </div>
          <div class="admin-ticket-shell">
            <div class="admin-ticket-empty">
              No suggestion yet. Use
              <span class="text-power">Generate Suggestions</span>.
            </div>
          </div>
        </section>

        <section class="admin-column" id="slot-evergreen">
          <div class="admin-column-header">
            <div class="admin-column-title">Slot 3</div>
            <div class="admin-column-badge evergreen">Evergreen</div>
          </div>
          <div class="admin-ticket-shell">
            <div class="admin-ticket-empty">
              No suggestion yet. Use
              <span class="text-power">Generate Suggestions</span>.
            </div>
          </div>
        </section>
      </main>

      <section class="admin-controls">
        <div class="admin-controls-left">
          <button id="btn-generate" class="btn btn-primary">
            Generate Suggestions
          </button>
          <button id="btn-show" class="btn btn-secondary" disabled>
            Show to Audience
          </button>
        </div>
        <div class="admin-controls-right">
          <button id="btn-clear-selection" class="btn btn-secondary" disabled>
            Reset selection
          </button>
          <button id="btn-start" class="btn btn-danger" disabled>
            Start Next Song
          </button>
          <div class="admin-status" id="status-text">
            No selection made yet.
          </div>
        </div>
      </section>

      <section class="admin-manual">
        <div class="admin-manual-header">
          Manual song selection from database
        </div>
        <div class="admin-manual-row admin-manual-row-bottom">
          <div class="admin-manual-col">
            <div class="admin-manual-col-header text-power">Power</div>
            <label class="admin-manual-field admin-manual-search">
              Search
              <input
                type="text"
                id="manual-search-power"
                placeholder="Search by title or artist…"
              />
            </label>
            <div class="admin-manual-table-wrapper">
              <table class="admin-manual-table">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Artist</th>
                  </tr>
                </thead>
                <tbody id="manual-song-tbody-power"></tbody>
              </table>
            </div>
            <button
              id="btn-manual-set-power"
              class="btn btn-secondary btn-small"
            >
              Set to slot 1
            </button>
          </div>

          <div class="admin-manual-col">
            <div class="admin-manual-col-header text-emotional">Emotional</div>
            <label class="admin-manual-field admin-manual-search">
              Search
              <input
                type="text"
                id="manual-search-emotional"
                placeholder="Search by title or artist…"
              />
            </label>
            <div class="admin-manual-table-wrapper">
              <table class="admin-manual-table">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Artist</th>
                  </tr>
                </thead>
                <tbody id="manual-song-tbody-emotional"></tbody>
              </table>
            </div>
            <button
              id="btn-manual-set-emotional"
              class="btn btn-secondary btn-small"
            >
              Set to slot 2
            </button>
          </div>

          <div class="admin-manual-col">
            <div class="admin-manual-col-header text-evergreen">
              Evergreen
            </div>
            <label class="admin-manual-field admin-manual-search">
              Search
              <input
                type="text"
                id="manual-search-evergreen"
                placeholder="Search by title or artist…"
              />
            </label>
            <div class="admin-manual-table-wrapper">
              <table class="admin-manual-table">
                <thead>
                  <tr>
                    <th>Title</th>
                    <th>Artist</th>
                  </tr>
                </thead>
                <tbody id="manual-song-tbody-evergreen"></tbody>
              </table>
            </div>
            <button
              id="btn-manual-set-evergreen"
              class="btn btn-secondary btn-small"
            >
              Set to slot 3
            </button>
          </div>
        </div>
        <div class="admin-manual-hint">
          Choose a song from the database and set it as a suggestion for the
          matching slot. The audience can then vote as usual with
          <span class="text-power">1</span>,
          <span class="text-emotional">2</span> or
          <span class="text-evergreen">3</span>.
        </div>
      </section>
    </div>

    <!-- Data and shared logic -->
    <script src="data.js"></script>
    <script src="logic.js"></script>

    <script>
      // Local state
      const playedSongIds = new Set();
      const currentSuggestions = {
        power: null,
        emotional: null,
        evergreen: null,
      };
      let nextSong = null;
      let nextSlot = null;

      // DOM references
      const btnGenerate = document.getElementById("btn-generate");
      const btnShow = document.getElementById("btn-show");
      const btnStart = document.getElementById("btn-start");
      const btnClearSelection = document.getElementById("btn-clear-selection");
      const statusText = document.getElementById("status-text");
      const manualSongTableBodies = {
        power: document.getElementById("manual-song-tbody-power"),
        emotional: document.getElementById("manual-song-tbody-emotional"),
        evergreen: document.getElementById("manual-song-tbody-evergreen"),
      };
      const manualSearchInputs = {
        power: document.getElementById("manual-search-power"),
        emotional: document.getElementById("manual-search-emotional"),
        evergreen: document.getElementById("manual-search-evergreen"),
      };
      const btnManualSetBySlot = {
        power: document.getElementById("btn-manual-set-power"),
        emotional: document.getElementById("btn-manual-set-emotional"),
        evergreen: document.getElementById("btn-manual-set-evergreen"),
      };
      const manualSelectedSongId = {
        power: null,
        emotional: null,
        evergreen: null,
      };

      const slotEls = {
        power: document.getElementById("slot-power"),
        emotional: document.getElementById("slot-emotional"),
        evergreen: document.getElementById("slot-evergreen"),
      };

      function randomChoice(arr) {
        if (!arr.length) return null;
        const idx = Math.floor(Math.random() * arr.length);
        return arr[idx];
      }

      function pickSongForCategory(category) {
        if (!Array.isArray(window.SONGS)) return null;
        const allInCat = window.SONGS.filter(
          (s) => s.category === category
        );
        if (!allInCat.length) return null;

        const unplayed = allInCat.filter((s) => !playedSongIds.has(s.id));
        const pool = unplayed.length ? unplayed : allInCat;
        return randomChoice(pool);
      }

      function renderSlot(slot, song) {
        const slotEl = slotEls[slot];
        if (!slotEl) return;
        const shell = slotEl.querySelector(".admin-ticket-shell");
        if (!shell) return;

        shell.innerHTML = "";

        if (!song) {
          const empty = document.createElement("div");
          empty.className = "admin-ticket-empty";
          empty.textContent =
            "No suggestion yet. Use Generate Suggestions.";
          shell.appendChild(empty);
          return;
        }

        const ticket = document.createElement("div");
        ticket.className =
          "ticket ticket-" +
          slot +
          " visible" +
          (nextSong && nextSong.id === song.id ? " locked" : "");
        ticket.style.pointerEvents = "none";

        const keyLabel = slot === "power" ? "1" : slot === "emotional" ? "2" : "3";

        ticket.innerHTML =
          '<div class="ticket-inner">' +
          '<div class="ticket-key">' +
          keyLabel +
          "</div>" +
          '<div class="ticket-label">' +
          (slot === "power"
            ? "Power"
            : slot === "emotional"
            ? "Emotional"
            : "Evergreen") +
          "</div>" +
          '<div class="ticket-title">' +
          song.title +
          "</div>" +
          '<div class="ticket-artist">' +
          song.artist +
          "</div>" +
          '<div class="ticket-shortcode">YouTube ID: ' +
          song.youtubeId +
          "</div>" +
          "</div>";

        shell.appendChild(ticket);
      }

      function renderAllSlots() {
        ["power", "emotional", "evergreen"].forEach((slot) => {
          renderSlot(slot, currentSuggestions[slot]);
        });
      }

      function updateStatus() {
        if (!nextSong) {
          statusText.innerHTML =
            'No selection made yet. Use <span class="text-power">1</span>, <span class="text-emotional">2</span> or <span class="text-evergreen">3</span>.';
          return;
        }
        statusText.innerHTML =
          'Next: <span class="admin-status-strong">' +
          nextSong.title +
          "</span> – " +
          nextSong.artist +
          " (" +
          (nextSlot === "power"
            ? "Power"
            : nextSlot === "emotional"
            ? "Emotional"
            : "Evergreen") +
          ")";
      }

      function handleGenerate() {
        currentSuggestions.power = pickSongForCategory("power");
        currentSuggestions.emotional = pickSongForCategory("emotional");
        currentSuggestions.evergreen = pickSongForCategory("evergreen");

        renderAllSlots();

        btnShow.disabled =
          !currentSuggestions.power &&
          !currentSuggestions.emotional &&
          !currentSuggestions.evergreen;

        // Reset locked state
        nextSong = null;
        nextSlot = null;
        btnStart.disabled = true;
        if (btnClearSelection) btnClearSelection.disabled = true;
        updateStatus();
      }

      function handleShowToAudience() {
        if (!window.sendKaraokeMessage) return;
        window.sendKaraokeMessage("SHOW_OPTIONS", {
          power: currentSuggestions.power,
          emotional: currentSuggestions.emotional,
          evergreen: currentSuggestions.evergreen,
        });
      }

      function setManualSelectedRow(slot, id) {
        manualSelectedSongId[slot] = id;
        const body = manualSongTableBodies[slot];
        if (!body) return;

        const rows = Array.from(body.querySelectorAll("tr"));
        rows.forEach((row) => {
          const rowId = parseInt(row.dataset.songId || "0", 10);
          if (rowId === id) {
            row.classList.add("selected");
          } else {
            row.classList.remove("selected");
          }
        });

        const btn = btnManualSetBySlot[slot];
        if (btn) {
          btn.disabled = !id;
        }
      }

      function renderManualSongOptions(slotFilter) {
        if (!window.SONGS) return;
        const allSongs = Array.isArray(window.SONGS) ? window.SONGS : [];

        const slotsToRender = slotFilter
          ? [slotFilter]
          : ["power", "emotional", "evergreen"];

        slotsToRender.forEach((slot) => {
          const body = manualSongTableBodies[slot];
          if (!body) return;

          body.innerHTML = "";
          manualSelectedSongId[slot] = null;

          const input = manualSearchInputs[slot];
          const search = input ? input.value.toLowerCase() : "";

          const filtered = allSongs.filter((song) => {
            if (song.category !== slot) return false;
            if (!search) return true;
            const haystack = (song.title + " " + song.artist).toLowerCase();
            return haystack.includes(search);
          });

          filtered.forEach((song) => {
            const row = document.createElement("tr");
            row.dataset.songId = String(song.id);

            const titleCell = document.createElement("td");
            titleCell.className = "col-title";
            titleCell.textContent = song.title;

            const artistCell = document.createElement("td");
            artistCell.className = "col-artist";
            artistCell.textContent = song.artist;

            row.appendChild(titleCell);
            row.appendChild(artistCell);

            row.addEventListener("click", () => {
              setManualSelectedRow(slot, song.id);
            });

            body.appendChild(row);
          });

          const btn = btnManualSetBySlot[slot];
          if (btn) {
            // Disable if there are no songs or no row has been selected yet.
            btn.disabled = filtered.length === 0 || !manualSelectedSongId[slot];
          }
        });
      }

      function handleManualSet(slot) {
        if (!window.SONGS || !manualSelectedSongId[slot]) return;
        const id = manualSelectedSongId[slot];

        const allSongs = Array.isArray(window.SONGS) ? window.SONGS : [];
        const song = allSongs.find((s) => s.id === id);
        if (!song) return;

        const effectiveSlot = slot || song.category || "power";
        currentSuggestions[effectiveSlot] = song;

        renderAllSlots();

        btnShow.disabled =
          !currentSuggestions.power &&
          !currentSuggestions.emotional &&
          !currentSuggestions.evergreen;

        // Reset any previously locked choice since suggestions changed.
        nextSong = null;
        nextSlot = null;
        btnStart.disabled = true;
        if (btnClearSelection) btnClearSelection.disabled = true;
        updateStatus();

        // Ensure projector is also unlocked and shows updated options.
        if (window.sendKaraokeMessage) {
          window.sendKaraokeMessage("SHOW_OPTIONS", {
            power: currentSuggestions.power,
            emotional: currentSuggestions.emotional,
            evergreen: currentSuggestions.evergreen,
          });
        }
      }

      function slotFromKey(key) {
        if (key === "1") return "power";
        if (key === "2") return "emotional";
        if (key === "3") return "evergreen";
        return null;
      }

      function handleChoiceKey(key) {
        const slot = slotFromKey(key);
        if (!slot) return;
        if (nextSong) {
          // Already locked for this round, ignore further keys.
          return;
        }

        const song = currentSuggestions[slot];
        if (!song) return;

        nextSong = song;
        nextSlot = slot;
        btnStart.disabled = false;
        if (btnClearSelection) btnClearSelection.disabled = false;
        updateStatus();
        renderAllSlots();

        if (window.sendKaraokeMessage) {
          window.sendKaraokeMessage("LOCK_CHOICE", {
            slot,
            song,
          });
        }
      }

      function handleClearSelection() {
        if (!nextSong) return;

        nextSong = null;
        nextSlot = null;
        btnStart.disabled = true;
        if (btnClearSelection) btnClearSelection.disabled = true;

        updateStatus();
        renderAllSlots();

        // Tell projector to show all options again (remove lock).
        if (window.sendKaraokeMessage) {
          window.sendKaraokeMessage("SHOW_OPTIONS", {
            power: currentSuggestions.power,
            emotional: currentSuggestions.emotional,
            evergreen: currentSuggestions.evergreen,
          });
        }
      }

      function handleStartNextSong() {
        if (!nextSong || !window.sendKaraokeMessage) return;

        window.sendKaraokeMessage("PLAY_SONG", {
          youtubeId: nextSong.youtubeId,
          song: nextSong,
        });

        playedSongIds.add(nextSong.id);

        // Mark as consumed, but keep status until next suggestion round
        btnStart.disabled = true;
        if (btnClearSelection) btnClearSelection.disabled = true;
        updateStatus();
      }

      function handleAdminKeydown(ev) {
        const key = ev.key;
        if (key === "1" || key === "2" || key === "3") {
          handleChoiceKey(key);
        }
      }

      function handleBroadcast(msg) {
        if (!msg || !msg.action) return;
        if (msg.action === "AUDIENCE_KEY") {
          const key = msg.payload && msg.payload.key;
          if (key) {
            handleChoiceKey(key);
          }
        }
      }

      function init() {
        btnGenerate.addEventListener("click", handleGenerate);
        btnShow.addEventListener("click", handleShowToAudience);
        btnStart.addEventListener("click", handleStartNextSong);
        if (btnClearSelection) {
          btnClearSelection.addEventListener("click", handleClearSelection);
        }
        window.addEventListener("keydown", handleAdminKeydown);

        Object.entries(manualSearchInputs).forEach(([slot, input]) => {
          if (input) {
            input.addEventListener("input", () =>
              renderManualSongOptions(slot)
            );
          }
        });
        if (btnManualSetBySlot.power) {
          btnManualSetBySlot.power.addEventListener("click", () =>
            handleManualSet("power")
          );
        }
        if (btnManualSetBySlot.emotional) {
          btnManualSetBySlot.emotional.addEventListener("click", () =>
            handleManualSet("emotional")
          );
        }
        if (btnManualSetBySlot.evergreen) {
          btnManualSetBySlot.evergreen.addEventListener("click", () =>
            handleManualSet("evergreen")
          );
        }

        if (window.onKaraokeMessage) {
          window.onKaraokeMessage(handleBroadcast);
        }

        renderManualSongOptions();
        updateStatus();
      }

      window.addEventListener("DOMContentLoaded", init);
    </script>
  </body>
</html>


